<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sulo - PoE2 Temple Rating</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #141414;
            --bg-panel: #1e1e1e;
            --bg-cell: #252525;
            --bg-cell-empty: #1a1a1a;
            --bg-hover: #2a2a2a;
            --border: #333;
            --border-gold: #6b5b3d;
            --gold: #a08050;
            --gold-light: #c9a860;
            --green: #4ade80;
            --blue: #60a5fa;
            --red: #f87171;
            --purple: #c084fc;
            --cyan: #22d3ee;
            --orange: #fb923c;
            --text: #d4d4d4;
            --text-muted: #888;
            --text-dim: #555;
            --radius: 5px;
            --radius-sm: 2.5px;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--text-muted);
        }
        
        .input-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--gold-light);
        }
        
        .input-section textarea {
            width: 100%;
            height: 100px;
            background: var(--bg-cell);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            color: var(--text);
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: var(--gold);
        }
        
        .analyze-btn {
            width: 100%;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, var(--gold), #8b6914);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(160, 128, 80, 0.3);
        }
        
        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-section.visible {
            display: block;
        }
        
        .rating-card {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid var(--border);
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stars {
            font-size: 64px;
            margin: 20px 0;
            letter-spacing: 8px;
        }
        
        .star {
            color: var(--border);
            cursor: default;
        }
        
        .star.filled {
            color: var(--gold);
            text-shadow: 0 0 20px rgba(201, 168, 96, 0.5);
        }
        
        .star.half {
            background: linear-gradient(90deg, var(--gold) 50%, var(--border) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rating-title {
            font-size: 1.8rem;
            color: var(--gold-light);
            margin-bottom: 10px;
        }
        
        .rating-description {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .score-display {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }
        
        .score-item {
            text-align: center;
        }
        
        .score-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .score-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-cell);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--blue);
        }
        
        .stat-value.green { color: var(--green); }
        .stat-value.purple { color: var(--purple); }
        .stat-value.cyan { color: var(--cyan); }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .tech-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .tech-badge {
            background: var(--bg-cell);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .tech-badge.active {
            background: rgba(160, 128, 80, 0.2);
            border-color: var(--gold);
            color: var(--gold-light);
        }
        
        .suggestions {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
        }
        
        .suggestions h3 {
            color: var(--cyan);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .suggestions ul {
            list-style: none;
        }
        
        .suggestions li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .suggestions li:last-child {
            border-bottom: none;
        }
        
        .suggestions li::before {
            content: "‚Üí";
            color: var(--cyan);
        }
        
        .criteria-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .criteria-section h3 {
            color: var(--gold-light);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .evaluation-section {
            background: var(--bg-panel);
            border-radius: var(--radius);
            padding: 15px;
            border: 1px solid var(--border);
            margin-top: 20px;
            overflow-y: auto;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .evaluation-header h3 {
            color: var(--gold-light);
            font-size: 13.75px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.625px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            color: var(--text-muted);
            transition: transform 0.3s ease;
            font-size: 12.5px;
        }

        .toggle-icon.open {
            transform: rotate(180deg);
        }

        .evaluation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .evaluation-content.open {
            max-height: 2000px;
            margin-top: 15px;
        }

        .metric-row {
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.08);
            border-left: 3px solid var(--gold);
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s ease;
        }

        .metric-row:hover {
            background: rgba(99, 102, 241, 0.12);
            border-left-color: var(--gold-light);
        }

        .metric-row:last-child {
            margin-bottom: 0;
        }

        .metric-label {
            color: var(--text);
            font-size: 13px;
        }

        .metric-value {
            color: var(--gold);
            font-weight: 600;
            font-size: 13px;
        }

        .metric-value.green { color: var(--green); }
        .metric-value.blue { color: var(--blue); }
        .metric-value.red { color: var(--red); }
        .metric-value.purple { color: var(--purple); }
        .metric-value.cyan { color: var(--cyan); }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty-easy { background: rgba(74, 222, 128, 0.2); color: var(--green); }
        .difficulty-moderate { background: rgba(96, 165, 250, 0.2); color: var(--blue); }
        .difficulty-hard { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .difficulty-very-hard { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .difficulty-extreme { background: rgba(248, 113, 113, 0.2); color: var(--red); }

        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .rating-poor { background: rgba(248, 113, 113, 0.2); color: var(--red); }
        .rating-fair { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .rating-good { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .rating-excellent { background: rgba(74, 222, 128, 0.2); color: var(--green); }
        .rating-outstanding { background: rgba(192, 132, 252, 0.2); color: var(--purple); }

        .chain-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chain-item {
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.08);
            border-left: 3px solid var(--cyan);
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            transition: all 0.15s ease;
        }

        .chain-item:hover {
            background: rgba(99, 102, 241, 0.12);
            border-left-color: var(--cyan);
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chain-type {
            color: var(--cyan);
            font-weight: 600;
            font-size: 13px;
        }

        .chain-multiplier {
            color: var(--gold);
            font-weight: 600;
            font-size: 13px;
        }

        .chain-desc {
            color: rgba(168, 170, 255, 0.95);
            font-size: 12px;
        }

        .stacked-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stacked-item {
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.08);
            border-left: 3px solid var(--purple);
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            transition: all 0.15s ease;
        }

        .stacked-item:hover {
            background: rgba(99, 102, 241, 0.12);
            border-left-color: var(--purple);
        }

        .stacked-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .stacked-room {
            color: var(--purple);
            font-weight: 600;
            font-size: 13px;
        }

        .stacked-count {
            color: var(--text-muted);
            font-size: 12px;
        }

        .stacked-values {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 12px;
        }

        .stacked-values span {
            color: rgba(168, 170, 255, 0.95);
        }

        .stacked-values strong {
            color: var(--text);
        }

        .progress-bar-container {
            margin-top: 10px;
            padding: 0;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .risk-reward-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .risk-reward-card {
            background: var(--bg-cell);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
            transition: all 0.15s ease;
        }

        .risk-reward-card:hover {
            border-color: var(--border-gold);
            background: var(--bg-hover);
        }

        .risk-reward-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .risk-reward-value {
            font-size: 14px;
            font-weight: 600;
        }

        .recommendation-box {
            background: rgba(99, 102, 241, 0.08);
            border-left: 3px solid var(--cyan);
            border-radius: 4px;
            padding: 10px 12px;
            margin-top: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .recommendation-box p {
            color: rgba(168, 170, 255, 0.95);
            margin: 0;
        }

        @media (max-width: 768px) {
            .risk-reward-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .criteria-item {
            background: var(--bg-cell);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .criteria-item:last-child {
            margin-bottom: 0;
        }
        
        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .criteria-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .criteria-points {
            color: var(--gold);
            font-weight: 600;
        }
        
        .criteria-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .progress-bar {
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.visible {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--red);
            border-radius: 8px;
            padding: 15px;
            color: var(--red);
            margin-top: 15px;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }

        /* Room Details Section Styles */
        .rooms-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .rooms-section h3 {
            color: var(--gold-light);
            margin-bottom: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .room-card {
            background: var(--bg-cell);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .room-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(160, 128, 80, 0.2);
        }

        .room-card.tier-7 { border-left: 3px solid var(--purple); }
        .room-card.tier-6 { border-left: 3px solid var(--gold); }
        .room-card.tier-5 { border-left: 3px solid var(--orange); }
        .room-card.tier-4 { border-left: 3px solid var(--blue); }
        .room-card.tier-3 { border-left: 3px solid var(--green); }
        .room-card.tier-2 { border-left: 3px solid var(--cyan); }
        .room-card.tier-1 { border-left: 3px solid var(--text-muted); }
        .room-card.special { border-left: 3px solid var(--red); }
        .room-card.boss { border-left: 3px solid #ff4444; }
        .room-card.architect { border-left: 3px solid var(--cyan); }

        .room-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .room-icon {
            font-size: 24px;
            margin-right: 8px;
        }

        .room-name {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            flex: 1;
        }

        .room-tier {
            background: var(--bg-dark);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
        }

        .room-tier.tier-7 { color: var(--purple); }
        .room-tier.tier-6 { color: var(--gold); }
        .room-tier.tier-5 { color: var(--orange); }

        .room-position {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .room-effects {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .room-effect-item {
            display: flex;
            align-items: start;
            gap: 6px;
            margin-bottom: 4px;
        }

        .room-effect-item:last-child {
            margin-bottom: 0;
        }

        .effect-bullet {
            color: var(--gold);
            font-size: 8px;
            margin-top: 3px;
        }

        .room-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .room-type-badge.reward { background: rgba(160, 128, 80, 0.2); color: var(--gold); }
        .room-type-badge.special { background: rgba(248, 113, 113, 0.2); color: var(--red); }
        .room-type-badge.boss { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .room-type-badge.architect { background: rgba(34, 211, 238, 0.2); color: var(--cyan); }
        .room-type-badge.path { background: rgba(136, 136, 136, 0.2); color: var(--text-muted); }
        .room-type-badge.empty { background: rgba(85, 85, 85, 0.2); color: var(--text-dim); }

        .room-card.expanded .room-details {
            display: block;
        }

        .room-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .room-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .room-detail-label {
            color: var(--text-muted);
        }

        .room-detail-value {
            color: var(--gold);
            font-weight: 500;
        }

        .room-loot-modifiers {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .loot-modifier-tag {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .loot-modifier-tag.positive { color: var(--green); }
        .loot-modifier-tier { color: var(--gold); }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--bg-cell);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--gold);
            color: var(--text);
        }

        .filter-btn.active {
            background: rgba(160, 128, 80, 0.2);
            border-color: var(--gold);
            color: var(--gold-light);
        }

        .room-stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-cell);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .room-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .room-stat-value {
            color: var(--gold);
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            .filter-buttons {
                gap: 6px;
            }
            .filter-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è PoE2 Temple Rating</h1>
            <p>Analyze your Vaal Temple layout and get instant star rating</p>
        </div>
        
        <div class="input-section">
            <label>Paste your Temple Share URL</label>
            <textarea id="shareUrl" placeholder="http://127.0.0.1:8080/#/atziri-temple?t=AEghSCFIIjFoMSF6cHpwaTESEkhwc..."></textarea>
            <button class="analyze-btn" onclick="analyzeTemple()">Analyze & Rate</button>
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing temple layout...</p>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="rating-card">
                <div class="stars" id="stars"></div>
                <h2 class="rating-title" id="ratingTitle"></h2>
                <p class="rating-description" id="ratingDescription"></p>
                
                <div class="score-display">
                    <div class="score-item">
                        <div class="score-value" id="totalScore">0</div>
                        <div class="score-label">Total Score</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="rewardScore">0</div>
                        <div class="score-label">Reward Score</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="techScore">0</div>
                        <div class="score-label">Tech Score</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="roomCount">0</div>
                    <div class="stat-label">Total Rooms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value green" id="rewardRooms">0</div>
                    <div class="stat-label">Reward Rooms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value purple" id="architectRooms">0</div>
                    <div class="stat-label">Architects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value cyan" id="rewardDensity">0%</div>
                    <div class="stat-label">Reward Density</div>
                </div>
            </div>
            
            <div class="tech-badges" id="techBadges"></div>
            
            <div class="suggestions" id="suggestionsSection" style="display: none;">
                <h3>üí° Improvement Suggestions</h3>
                <ul id="suggestionsList"></ul>
            </div>
            
            <div class="criteria-section">
                <h3>üìä Rating Criteria</h3>
                <div class="criteria-item">
                    <div class="criteria-header">
                        <span class="criteria-name">Snake Score</span>
                        <span class="criteria-points">0-40 points</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="rewardProgress" style="width: 0%"></div>
                    </div>
                    <div class="criteria-desc">Based on snake chain length (8+ rooms = 40pts)</div>
                </div>
                <div class="criteria-item">
                    <div class="criteria-header">
                        <span class="criteria-name">Room Quality</span>
                        <span class="criteria-points">0-50 points</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="techProgress" style="width: 0%"></div>
                    </div>
                    <div class="criteria-desc">Spymaster (10pts) + Golem (8pts) + T7 Room (30pts) + T6 Room (3pts)</div>
                </div>
                <div class="criteria-item">
                    <div class="criteria-header">
                        <span class="criteria-name">Quantity Score</span>
                        <span class="criteria-points">0-15 points</span>
                    </div>
                    <div class="criteria-desc">Based on total reward rooms (18+ rooms = 15pts)</div>
                </div>
            </div>

            <div class="evaluation-section" id="chainedBonusesSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('chainedBonuses')">
                    <h3>üîó Chained Room Bonuses</h3>
                    <span class="toggle-icon" id="chainedBonusesIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="chainedBonusesContent">
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Connected high-tier rooms provide multipliers (15% per room in chain)</p>
                    <ul class="chain-list" id="chainedBonusesList"></ul>
                </div>
            </div>

            <div class="evaluation-section" id="stackedBonusesSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('stackedBonuses')">
                    <h3>üìö Stacked Bonuses (Diminishing Returns)</h3>
                    <span class="toggle-icon" id="stackedBonusesIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="stackedBonusesContent">
                    <p style="color: var(--text-muted); margin-bottom: 15px;">Duplicate valuable rooms with 30% diminishing returns per additional room</p>
                    <ul class="stacked-list" id="stackedBonusesList"></ul>
                </div>
            </div>

            <div class="evaluation-section" id="monsterScalingSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('monsterScaling')">
                    <h3>‚öîÔ∏è Monster Scaling</h3>
                    <span class="toggle-icon" id="monsterScalingIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="monsterScalingContent">
                    <div class="metric-row">
                        <span class="metric-label">Difficulty Level</span>
                        <span class="metric-value" id="monsterDifficulty"></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Average Tier</span>
                        <span class="metric-value" id="avgTier"></span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Monster Density</span>
                            <span id="monsterDensityValue">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="monsterDensityBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Rare Monster Chance</span>
                            <span id="rareChanceValue">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="rareChanceBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Boss Present</span>
                        <span class="metric-value" id="bossPresent"></span>
                    </div>
                </div>
            </div>

            <div class="evaluation-section" id="lootModifiersSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('lootModifiers')">
                    <h3>üíé Loot Modifiers</h3>
                    <span class="toggle-icon" id="lootModifiersIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="lootModifiersContent">
                    <div class="metric-row">
                        <span class="metric-label">Currency Multiplier</span>
                        <span class="metric-value gold" id="currencyMultiplier"></span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Rare Item Chance</span>
                            <span id="rareItemValue">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="rareItemBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Unique Item Chance</span>
                            <span id="uniqueItemValue">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="uniqueItemBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Corruption Available</span>
                        <span class="metric-value" id="corruptionAvailable"></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Sacrifice Value</span>
                        <span class="metric-value purple" id="sacrificeValue"></span>
                    </div>
                </div>
            </div>

            <div class="evaluation-section" id="farmingSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('farming')">
                    <h3>üåæ Farming Assessment</h3>
                    <span class="toggle-icon" id="farmingIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="farmingContent">
                    <div class="metric-row">
                        <span class="metric-label">Currency Farming</span>
                        <span class="metric-value" id="currencyFarming"></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Rare Monster Farming</span>
                        <span class="metric-value" id="rareMonsterFarming"></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Item Farming</span>
                        <span class="metric-value" id="itemFarming"></span>
                    </div>
                    <div class="recommendation-box">
                        <p id="farmingRecommendation" style="color: var(--cyan);"></p>
                    </div>
                </div>
            </div>

            <div class="evaluation-section" id="riskRewardSection" style="display: none;">
                <div class="evaluation-header" onclick="toggleSection('riskReward')">
                    <h3>‚öñÔ∏è Risk vs Reward</h3>
                    <span class="toggle-icon" id="riskRewardIcon">‚ñº</span>
                </div>
                <div class="evaluation-content" id="riskRewardContent">
                    <div class="risk-reward-grid">
                        <div class="risk-reward-card">
                            <div class="risk-reward-label">Risk Level</div>
                            <div class="risk-reward-value" id="riskLevel"></div>
                        </div>
                        <div class="risk-reward-card">
                            <div class="risk-reward-label">Reward Potential</div>
                            <div class="risk-reward-value" id="rewardPotential"></div>
                        </div>
                        <div class="risk-reward-card">
                            <div class="risk-reward-label">Time Investment</div>
                            <div class="risk-reward-value" id="timeInvestment"></div>
                        </div>
                    </div>
                    <div class="recommendation-box">
                        <p id="riskRecommendation"></p>
                    </div>
                </div>
            </div>

            <div class="rooms-section" id="roomsSection" style="display: none;">
                <h3>üèõÔ∏è Temple Rooms Details</h3>
                <div class="room-stats-summary" id="roomStatsSummary"></div>
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" data-filter="all">All Rooms</button>
                    <button class="filter-btn" data-filter="reward">Reward Rooms</button>
                    <button class="filter-btn" data-filter="special">Special</button>
                    <button class="filter-btn" data-filter="boss">Boss</button>
                    <button class="filter-btn" data-filter="architect">Architect</button>
                    <button class="filter-btn" data-filter="tier-7">Tier 7</button>
                    <button class="filter-btn" data-filter="tier-6">Tier 6+</button>
                </div>
                <div class="rooms-grid" id="roomsGrid"></div>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';

            // Multiple charset versions for compatibility
        const CHARSETS = [
            // Base-40 charset with 467 (newest)
            '467ABCDEFHIJKMOPQRSTUWXYaghijklmnopuwxy',
            // Base-32 charset
            'ABCDEFHIJKMOQRSTWXYaceghijkopqwx',
            // Base-40 newest charset (2026)
            '056ABCEFGIJKMQSTWXYaceghijklnopqrwxy',
            // Base-40 newer charset
            '56ABCDEFGIJKMOQRSUWXYaceghjklpwxy',
            // Base-40 old charset (legacy)
            '56ABCDEFGHIKMQRSTWYaceghjklnopwxy'
        ];

        // Room type ID to name mapping (based on PoE2 temple)
        const ROOM_TYPE_IDS = {
            0: 'empty',
            1: 'path',
            2: 'entry',
            3: 'boss',
            4: 'corruption',
            5: 'sacrifice',
            6: 'alchemy_lab',
            7: 'armoury',
            8: 'flesh_surgeon',
            9: 'garrison',
            10: 'generator',
            11: 'golem_works',
            12: 'reward_currency',
            13: 'smithy',
            14: 'synthflesh',
            15: 'thaumaturge',
            16: 'transcendent_barracks',
            17: 'vault',
            18: 'viper_legion_barracks',
            19: 'viper_spymaster',
            20: 'commander',
            21: 'architect',
            22: 'altar_of_sacrifice',
            23: 'sacrificial_chamber',
            24: 'reward_room',
            25: 'medallion_bonus',
            26: 'medallion_reroll',
            27: 'medallion_levelup',
            28: 'medallion_increase_max',
            29: 'medallion_prevent_delete',
            30: 'medallion_increase_tokens',
            31: 'unknown'
        };

        // Room type definitions with reward values and quality tiers
        const ROOM_TYPES = {
            // High Value Rooms (4 points)
            'reward_currency': { type: 'reward', baseValue: 4, highTierBonus: true },
            'vault': { type: 'reward', baseValue: 4, highTierBonus: true },

            // Medium-High Value Rooms (3 points)
            'alchemy_lab': { type: 'reward', baseValue: 3, highTierBonus: true },
            'flesh_surgeon': { type: 'reward', baseValue: 3, highTierBonus: true },
            'synthflesh': { type: 'reward', baseValue: 3, highTierBonus: true },
            'viper_spymaster': { type: 'reward', baseValue: 3, highTierBonus: true },
            'reward_room': { type: 'reward', baseValue: 3, highTierBonus: true },

            // Medium Value Rooms (2 points)
            'armoury': { type: 'reward', baseValue: 2, highTierBonus: true },
            'garrison': { type: 'reward', baseValue: 2, highTierBonus: true },
            'generator': { type: 'reward', baseValue: 2, highTierBonus: true },
            'golem_works': { type: 'reward', baseValue: 2, highTierBonus: true },
            'smithy': { type: 'reward', baseValue: 2, highTierBonus: true },
            'thaumaturge': { type: 'reward', baseValue: 2, highTierBonus: true },
            'transcendent_barracks': { type: 'reward', baseValue: 2, highTierBonus: true },
            'viper_legion_barracks': { type: 'reward', baseValue: 2, highTierBonus: true },

            // Special Rooms
            'corruption': { type: 'special', baseValue: 1, highTierBonus: false },
            'sacrifice_room': { type: 'special', baseValue: 0, highTierBonus: false },
            'sacrificial_chamber': { type: 'special', baseValue: 0, highTierBonus: false },

            // Architect
            'commander': { type: 'architect', baseValue: 0, highTierBonus: false },
            'architect': { type: 'architect', baseValue: 0, highTierBonus: false },

            // Boss
            'atziri': { type: 'boss', baseValue: 0, highTierBonus: false },
            'boss': { type: 'boss', baseValue: 0, highTierBonus: false },

            // Empty/Path
            'empty': { type: 'empty', baseValue: 0, highTierBonus: false },
            'path': { type: 'path', baseValue: 0, highTierBonus: false },

            // Medallion rooms
            'medallion_bonus': { type: 'special', baseValue: 0, highTierBonus: false },
            'medallion_reroll': { type: 'special', baseValue: 0, highTierBonus: false },
            'medallion_levelup': { type: 'special', baseValue: 0, highTierBonus: false },
            'medallion_increase_max': { type: 'special', baseValue: 0, highTierBonus: false },
            'medallion_prevent_delete': { type: 'special', baseValue: 0, highTierBonus: false },
            'medallion_increase_tokens': { type: 'special', baseValue: 0, highTierBonus: false },

            // Unknown
            'unknown': { type: 'unknown', baseValue: 1, highTierBonus: false },
        };

        // Room effects and descriptions
        const ROOM_EFFECTS = {
            'viper_spymaster': {
                icon: 'üêç',
                name: 'Viper Spymaster',
                nameVi: 'Ch·ªâ Huy R·∫Øn ƒê·ªôc',
                effects: [
                    'Increases rare monster spawn rate',
                    'Adds additional loot from rare monsters',
                    'Enhances monster pack size'
                ],
                effectsVi: [
                    'TƒÉng t·ª∑ l·ªá xu·∫•t hi·ªán qu√°i hi·∫øm',
                    'Th√™m ph·∫ßn th∆∞·ªüng t·ª´ qu√°i hi·∫øm',
                    'TƒÉng k√≠ch th∆∞·ªõc ƒë√†n qu√°i'
                ],
                monsterScaling: 'High density, more rare monsters',
                lootMods: '+15-30% rare monster chance per tier'
            },
            'golem_works': {
                icon: 'üóø',
                name: 'Golem Works',
                nameVi: 'X∆∞·ªüng Golem',
                effects: [
                    'Spawns powerful golems',
                    'Increases item rarity',
                    'Adds unique item drops'
                ],
                effectsVi: [
                    'Tri·ªáu h·ªìi golem m·∫°nh m·∫Ω',
                    'TƒÉng ƒë·ªô hi·∫øm v·∫≠t ph·∫©m',
                    'Th√™m v·∫≠t ph·∫©m ƒë·ªôc nh·∫•t'
                ],
                monsterScaling: 'Elite golems with high HP',
                lootMods: '+10-20% unique item chance per tier'
            },
            'vault': {
                icon: 'üí∞',
                name: 'Vault',
                nameVi: 'Kho B√°u',
                effects: [
                    'Massive currency rewards',
                    'Increased currency drop rate',
                    'Stacks of valuable currency'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng ti·ªÅn t·ªá kh·ªïng l·ªì',
                    'TƒÉng t·ª∑ l·ªá r∆°i ti·ªÅn t·ªá',
                    'Nhi·ªÅu ti·ªÅn t·ªá gi√° tr·ªã'
                ],
                monsterScaling: 'Standard density',
                lootMods: '+25-50% currency multiplier per tier'
            },
            'corruption': {
                icon: '‚ö°',
                name: 'Corruption Chamber',
                nameVi: 'Ph√≤ng Tha H√≥a',
                effects: [
                    'Corrupts items for powerful mods',
                    'Risk/reward mechanic',
                    'Can brick or enhance items'
                ],
                effectsVi: [
                    'Tha h√≥a v·∫≠t ph·∫©m ƒë·ªÉ c√≥ thu·ªôc t√≠nh m·∫°nh',
                    'C∆° ch·∫ø r·ªßi ro/ph·∫ßn th∆∞·ªüng',
                    'C√≥ th·ªÉ ph√° ho·∫∑c n√¢ng c·∫•p v·∫≠t ph·∫©m'
                ],
                monsterScaling: 'N/A - Utility room',
                lootMods: 'Corruption altar available'
            },
            'sacrifice': {
                icon: 'üî•',
                name: 'Sacrifice Chamber',
                nameVi: 'Ph√≤ng Hi·∫øn T·∫ø',
                effects: [
                    'Sacrifice items for rewards',
                    'Higher tier = better rewards',
                    'Unique sacrifice outcomes'
                ],
                effectsVi: [
                    'Hi·∫øn t·∫ø v·∫≠t ph·∫©m ƒë·ªÉ nh·∫≠n th∆∞·ªüng',
                    'C·∫•p cao h∆°n = th∆∞·ªüng t·ªët h∆°n',
                    'K·∫øt qu·∫£ hi·∫øn t·∫ø ƒë·ªôc ƒë√°o'
                ],
                monsterScaling: 'N/A - Utility room',
                lootMods: 'Sacrifice value scales with tier'
            },
            'reward_currency': {
                icon: 'üíé',
                name: 'Currency Room',
                nameVi: 'Ph√≤ng Ti·ªÅn T·ªá',
                effects: [
                    'Guaranteed currency drops',
                    'High-value currency types',
                    'Scales with room tier'
                ],
                effectsVi: [
                    'ƒê·∫£m b·∫£o r∆°i ti·ªÅn t·ªá',
                    'Lo·∫°i ti·ªÅn t·ªá gi√° tr·ªã cao',
                    'TƒÉng theo c·∫•p ph√≤ng'
                ],
                monsterScaling: 'Standard density',
                lootMods: '+20-40% currency per tier'
            },
            'alchemy_lab': {
                icon: '‚öóÔ∏è',
                name: 'Alchemy Lab',
                nameVi: 'Ph√≤ng Gi·∫£ Kim',
                effects: [
                    'Alchemy currency rewards',
                    'Crafting material drops',
                    'Quality enhancement items'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng ti·ªÅn t·ªá gi·∫£ kim',
                    'R∆°i nguy√™n li·ªáu ch·∫ø t·∫°o',
                    'V·∫≠t ph·∫©m n√¢ng c·∫•p ch·∫•t l∆∞·ª£ng'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+15-25% crafting materials per tier'
            },
            'flesh_surgeon': {
                icon: 'ü©∏',
                name: 'Flesh Surgeon',
                nameVi: 'B√°c Sƒ© X·∫ª Th·ªãt',
                effects: [
                    'Life flask rewards',
                    'Healing item drops',
                    'Increased flask quality'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng b√¨nh m√°u',
                    'R∆°i v·∫≠t ph·∫©m h·ªìi m√°u',
                    'TƒÉng ch·∫•t l∆∞·ª£ng b√¨nh'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+10-20% flask quality per tier'
            },
            'synthflesh': {
                icon: 'üß¨',
                name: 'Synthflesh',
                nameVi: 'Th·ªãt T·ªïng H·ª£p',
                effects: [
                    'Synthesized item rewards',
                    'Unique mod combinations',
                    'High-value crafting bases'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng v·∫≠t ph·∫©m t·ªïng h·ª£p',
                    'K·∫øt h·ª£p thu·ªôc t√≠nh ƒë·ªôc ƒë√°o',
                    'N·ªÅn ch·∫ø t·∫°o gi√° tr·ªã cao'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+15-30% synthesized items per tier'
            },
            'armoury': {
                icon: 'üõ°Ô∏è',
                name: 'Armoury',
                nameVi: 'Kho V≈© Kh√≠',
                effects: [
                    'Weapon and armor drops',
                    'Increased item level',
                    'Quality armaments'
                ],
                effectsVi: [
                    'R∆°i v≈© kh√≠ v√† gi√°p',
                    'TƒÉng c·∫•p ƒë·ªô v·∫≠t ph·∫©m',
                    'Trang b·ªã ch·∫•t l∆∞·ª£ng'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+10-15% item level per tier'
            },
            'garrison': {
                icon: '‚öîÔ∏è',
                name: 'Garrison',
                nameVi: 'ƒê·ªìn Tr√∫',
                effects: [
                    'Military-themed rewards',
                    'Increased monster packs',
                    'Combat-focused loot'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng ch·ªß ƒë·ªÅ qu√¢n s·ª±',
                    'TƒÉng ƒë√†n qu√°i',
                    'Ph·∫ßn th∆∞·ªüng t·∫≠p trung chi·∫øn ƒë·∫•u'
                ],
                monsterScaling: 'High density',
                lootMods: '+15-25% pack size per tier'
            },
            'generator': {
                icon: '‚öôÔ∏è',
                name: 'Generator',
                nameVi: 'M√°y Ph√°t',
                effects: [
                    'Energy-based rewards',
                    'Mechanical loot',
                    'Utility items'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng d·ª±a tr√™n nƒÉng l∆∞·ª£ng',
                    'Ph·∫ßn th∆∞·ªüng c∆° kh√≠',
                    'V·∫≠t ph·∫©m ti·ªán √≠ch'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+10-20% utility items per tier'
            },
            'smithy': {
                icon: 'üî®',
                name: 'Smithy',
                nameVi: 'L√≤ R√®n',
                effects: [
                    'Crafting currency',
                    'Blacksmith items',
                    'Quality enhancement'
                ],
                effectsVi: [
                    'Ti·ªÅn t·ªá ch·∫ø t·∫°o',
                    'V·∫≠t ph·∫©m th·ª£ r√®n',
                    'N√¢ng c·∫•p ch·∫•t l∆∞·ª£ng'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+15-25% quality items per tier'
            },
            'thaumaturge': {
                icon: 'üîÆ',
                name: 'Thaumaturge',
                nameVi: 'Ph√°p S∆∞',
                effects: [
                    'Magic item rewards',
                    'Spell-based loot',
                    'Increased magic find'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng v·∫≠t ph·∫©m ph√©p thu·∫≠t',
                    'Ph·∫ßn th∆∞·ªüng d·ª±a tr√™n ph√©p',
                    'TƒÉng t√¨m ki·∫øm ph√©p thu·∫≠t'
                ],
                monsterScaling: 'Moderate density',
                lootMods: '+15-30% magic items per tier'
            },
            'transcendent_barracks': {
                icon: 'üè∞',
                name: 'Transcendent Barracks',
                nameVi: 'Doanh Tr·∫°i Si√™u Vi·ªát',
                effects: [
                    'Elite soldier spawns',
                    'Military rewards',
                    'High-tier equipment'
                ],
                effectsVi: [
                    'Tri·ªáu h·ªìi l√≠nh tinh nhu·ªá',
                    'Ph·∫ßn th∆∞·ªüng qu√¢n s·ª±',
                    'Trang b·ªã c·∫•p cao'
                ],
                monsterScaling: 'High density, elite monsters',
                lootMods: '+20-35% elite drops per tier'
            },
            'viper_legion_barracks': {
                icon: 'üêâ',
                name: 'Viper Legion Barracks',
                nameVi: 'Doanh Tr·∫°i Qu√¢n ƒêo√†n R·∫Øn',
                effects: [
                    'Viper legion spawns',
                    'Poison-themed rewards',
                    'Chaos damage items'
                ],
                effectsVi: [
                    'Tri·ªáu h·ªìi qu√¢n ƒëo√†n r·∫Øn',
                    'Ph·∫ßn th∆∞·ªüng ch·ªß ƒë·ªÅ ƒë·ªôc',
                    'V·∫≠t ph·∫©m s√°t th∆∞∆°ng h·ªón lo·∫°n'
                ],
                monsterScaling: 'High density, poison monsters',
                lootMods: '+15-30% chaos items per tier'
            },
            'reward_room': {
                icon: 'üéÅ',
                name: 'Reward Room',
                nameVi: 'Ph√≤ng Ph·∫ßn Th∆∞·ªüng',
                effects: [
                    'General rewards',
                    'Mixed loot types',
                    'Balanced drops'
                ],
                effectsVi: [
                    'Ph·∫ßn th∆∞·ªüng chung',
                    'Nhi·ªÅu lo·∫°i ph·∫ßn th∆∞·ªüng',
                    'R∆°i c√¢n b·∫±ng'
                ],
                monsterScaling: 'Standard density',
                lootMods: '+10-20% general loot per tier'
            },
            'boss': {
                icon: 'üëπ',
                name: 'Boss Room',
                nameVi: 'Ph√≤ng Boss',
                effects: [
                    'Temple boss encounter',
                    'Guaranteed unique drops',
                    'High-value rewards'
                ],
                effectsVi: [
                    'G·∫∑p boss ƒë·ªÅn th·ªù',
                    'ƒê·∫£m b·∫£o r∆°i v·∫≠t ph·∫©m ƒë·ªôc nh·∫•t',
                    'Ph·∫ßn th∆∞·ªüng gi√° tr·ªã cao'
                ],
                monsterScaling: 'Boss fight - very high difficulty',
                lootMods: 'Boss-specific unique items'
            },
            'atziri': {
                icon: 'üëë',
                name: 'Atziri Boss',
                nameVi: 'Boss Atziri',
                effects: [
                    'Atziri encounter',
                    'Exclusive unique items',
                    'Endgame rewards'
                ],
                effectsVi: [
                    'G·∫∑p Atziri',
                    'V·∫≠t ph·∫©m ƒë·ªôc nh·∫•t ƒë·ªôc quy·ªÅn',
                    'Ph·∫ßn th∆∞·ªüng cu·ªëi game'
                ],
                monsterScaling: 'Endgame boss - extreme difficulty',
                lootMods: 'Atziri-specific uniques'
            },
            'architect': {
                icon: 'üë§',
                name: 'Architect',
                nameVi: 'Ki·∫øn Tr√∫c S∆∞',
                effects: [
                    'Architect encounter',
                    'Room upgrade opportunity',
                    'Tier advancement'
                ],
                effectsVi: [
                    'G·∫∑p ki·∫øn tr√∫c s∆∞',
                    'C∆° h·ªôi n√¢ng c·∫•p ph√≤ng',
                    'Ti·∫øn b·ªô c·∫•p ƒë·ªô'
                ],
                monsterScaling: 'Mini-boss encounter',
                lootMods: 'Room modification rewards'
            },
            'commander': {
                icon: '‚öúÔ∏è',
                name: 'Commander',
                nameVi: 'Ch·ªâ Huy',
                effects: [
                    'Commander encounter',
                    'Leadership rewards',
                    'Strategic loot'
                ],
                effectsVi: [
                    'G·∫∑p ch·ªâ huy',
                    'Ph·∫ßn th∆∞·ªüng l√£nh ƒë·∫°o',
                    'Ph·∫ßn th∆∞·ªüng chi·∫øn l∆∞·ª£c'
                ],
                monsterScaling: 'Elite encounter',
                lootMods: 'Commander-specific drops'
            },
            'sacrificial_chamber': {
                icon: 'üó°Ô∏è',
                name: 'Sacrificial Chamber',
                nameVi: 'Ph√≤ng Hi·∫øn T·∫ø',
                effects: [
                    'Sacrifice mechanics',
                    'Risk/reward system',
                    'Powerful outcomes'
                ],
                effectsVi: [
                    'C∆° ch·∫ø hi·∫øn t·∫ø',
                    'H·ªá th·ªëng r·ªßi ro/th∆∞·ªüng',
                    'K·∫øt qu·∫£ m·∫°nh m·∫Ω'
                ],
                monsterScaling: 'N/A - Utility room',
                lootMods: 'Sacrifice-based rewards'
            },
            'empty': {
                icon: '‚¨ú',
                name: 'Empty',
                nameVi: 'Tr·ªëng',
                effects: ['No special effects'],
                effectsVi: ['Kh√¥ng c√≥ hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát'],
                monsterScaling: 'N/A',
                lootMods: 'None'
            },
            'path': {
                icon: 'üö∂',
                name: 'Path',
                nameVi: 'L·ªëi ƒêi',
                effects: ['Connects rooms'],
                effectsVi: ['K·∫øt n·ªëi c√°c ph√≤ng'],
                monsterScaling: 'N/A',
                lootMods: 'None'
            }
        };

        function validateShareURL(url) {
            try {
                const parsed = new URL(url);
                // Validate protocol (prevent javascript:, data:, etc.)
                if (!parsed.protocol.startsWith('http')) {
                    throw new Error('Invalid protocol');
                }
                // Check for temple data parameter
                const hash = parsed.hash;
                if (!hash || !hash.includes('?t=')) {
                    throw new Error('Missing temple data parameter');
                }
                return true;
            } catch (error) {
                console.error('Invalid URL:', error);
                return false;
            }
        }

        function extractShareData(shareUrl) {
            try {
                const url = new URL(shareUrl);
                const hash = url.hash;
                const tParamMatch = hash.match(/\?t=([^&]+)/);
                if (tParamMatch) {
                    return tParamMatch[1];
                }
                return null;
            } catch {
                return null;
            }
        }

        function decodeTempleData(encoded) {
            if (!encoded) return null;

            try {
                // Auto-detect charset from encoded string
                const uniqueChars = [...new Set(encoded)].sort().join('');
                const charToVal = {};
                uniqueChars.split('').forEach((c, i) => charToVal[c] = i);
                const values = encoded.split('').map(c => charToVal[c]);

                // Check if valid 5-bit encoding (max value <= 31)
                if (!values.some(v => v === undefined) && Math.max(...values) <= 31) {
                    let bitString = '';
                    values.forEach(v => bitString += v.toString(2).padStart(5, '0'));

                    const rooms = [];
                    let pos = 0;

                    while (pos + 16 <= bitString.length) {
                        const x = parseInt(bitString.substring(pos, pos + 4), 2);
                        const y = parseInt(bitString.substring(pos + 4, pos + 8), 2);
                        const roomTypeId = parseInt(bitString.substring(pos + 8, pos + 13), 2);
                        const tier = parseInt(bitString.substring(pos + 13, pos + 16), 2);
                        pos += 16;

                        if (x < 16 && y < 16 && roomTypeId <= 31) {
                            const roomName = ROOM_TYPE_IDS[roomTypeId] || 'unknown_' + roomTypeId;
                            rooms.push({ x, y, room: roomName, tier, roomTypeId });
                        }
                    }

                    if (rooms.length > 5) {
                        console.log('Auto-detected charset with', uniqueChars.length, 'characters,', rooms.length, 'rooms');
                        return { rooms };
                    }
                }

                // Fall back to known charsets
                for (const charset of CHARSETS) {
                    const map = {};
                    charset.split('').forEach((c, i) => map[c] = i);
                    const charsetValues = encoded.split('').map(c => map[c]);

                    if (charsetValues.some(v => v === undefined)) continue;

                    let bitString = '';
                    charsetValues.forEach(v => bitString += v.toString(2).padStart(5, '0'));

                    const rooms = [];
                    let pos = 0;

                    while (pos + 16 <= bitString.length) {
                        const x = parseInt(bitString.substring(pos, pos + 4), 2);
                        const y = parseInt(bitString.substring(pos + 4, pos + 8), 2);
                        const roomTypeId = parseInt(bitString.substring(pos + 8, pos + 13), 2);
                        const tier = parseInt(bitString.substring(pos + 13, pos + 16), 2);
                        pos += 16;

                        if (x < 16 && y < 16 && roomTypeId <= 31) {
                            const roomName = ROOM_TYPE_IDS[roomTypeId] || 'unknown_' + roomTypeId;
                            rooms.push({ x, y, room: roomName, tier, roomTypeId });
                        }
                    }

                    if (rooms.length > 5) {
                        return { rooms };
                    }
                }

                throw new Error('Could not decode temple data');
            } catch (error) {
                console.error('Error decoding temple data:', error);
                return null;
            }
        }
        
        // Temple Evaluation Functions
        function analyzeChainedRooms(rooms) {
            const bonuses = [];
            const highTierRooms = rooms.filter(r => (r.tier || 0) >= 6);
            const visited = new Set();

            highTierRooms.forEach(room => {
                const key = `${room.x},${room.y}`;
                if (visited.has(key)) return;

                const chain = findConnectedChain(highTierRooms, room, visited);
                if (chain.length >= 3) {
                    const avgTier = chain.reduce((sum, r) => sum + (r.tier || 0), 0) / chain.length;
                    bonuses.push({
                        type: 'high_tier_chain',
                        description: `${chain.length} connected T${Math.floor(avgTier)}+ rooms`,
                        rooms: chain,
                        multiplier: 1 + chain.length * 0.15
                    });
                }
            });

            return bonuses;
        }

        function findConnectedChain(rooms, start, visited) {
            const chain = [start];
            visited.add(`${start.x},${start.y}`);

            rooms.forEach(room => {
                const key = `${room.x},${room.y}`;
                if (visited.has(key)) return;

                const isAdjacent = Math.abs(room.x - start.x) <= 1 && Math.abs(room.y - start.y) <= 1;
                if (isAdjacent) {
                    chain.push(...findConnectedChain(rooms, room, visited));
                }
            });

            return chain;
        }

        function analyzeStackedBonuses(rooms) {
            const bonuses = [];
            const roomCounts = new Map();

            rooms.forEach(room => {
                if (room.room && room.room !== 'empty' && room.room !== 'path') {
                    roomCounts.set(room.room, (roomCounts.get(room.room) || 0) + 1);
                }
            });

            const valuableRooms = ['golem_works', 'viper_spymaster', 'thaumaturge'];
            valuableRooms.forEach(roomType => {
                const count = roomCounts.get(roomType) || 0;
                if (count > 0) {
                    const baseValue = 100;
                    const drFactor = count > 1 ? Math.pow(0.7, count - 1) : 1;
                    const actualValue = baseValue * count * drFactor;
                    const drPercent = count > 1 ? (1 - drFactor) * 100 : 0;

                    bonuses.push({
                        roomType,
                        count,
                        baseValue,
                        actualValue: Math.round(actualValue),
                        diminishingReturn: Math.round(drPercent)
                    });
                }
            });

            return bonuses;
        }

        function analyzeMonsterScaling(rooms) {
            const rewardRooms = rooms.filter(r => r.room !== 'empty' && r.room !== 'path');
            const avgTier = rewardRooms.reduce((sum, r) => sum + (r.tier || 0), 0) / (rewardRooms.length || 1);

            const t7Count = rooms.filter(r => (r.tier || 0) >= 7).length;
            const t6Count = rooms.filter(r => (r.tier || 0) === 6).length;
            const bossPresent = rooms.some(r => r.room === 'boss' || r.room === 'atziri');

            let difficulty = 'Easy';
            if (avgTier >= 6.5 || t7Count >= 3) difficulty = 'Extreme';
            else if (avgTier >= 6 || t7Count >= 2) difficulty = 'Very Hard';
            else if (avgTier >= 5 || t6Count >= 4) difficulty = 'Hard';
            else if (avgTier >= 4) difficulty = 'Moderate';

            const monsterDensity = Math.min(100, (rewardRooms.length / 25) * 100 + avgTier * 5);
            const rareMonsterChance = Math.min(100, avgTier * 12 + t7Count * 10);

            return {
                averageTier: Math.round(avgTier * 10) / 10,
                difficulty,
                monsterDensity: Math.round(monsterDensity),
                rareMonsterChance: Math.round(rareMonsterChance),
                bossPresent
            };
        }

        function analyzeLootModifiers(rooms) {
            const t7Count = rooms.filter(r => (r.tier || 0) >= 7).length;
            const t6Count = rooms.filter(r => (r.tier || 0) === 6).length;
            const hasCorruption = rooms.some(r => r.room === 'corruption');
            const hasSacrifice = rooms.some(r => r.room === 'sacrifice' || r.room === 'sacrificial_chamber');
            const currencyRooms = rooms.filter(r => r.room === 'reward_currency' || r.room === 'vault').length;

            const currencyMultiplier = 1 + t7Count * 0.3 + t6Count * 0.15 + currencyRooms * 0.25;
            const rareItemChance = Math.min(100, 20 + t7Count * 15 + t6Count * 8);
            const uniqueItemChance = Math.min(50, 5 + t7Count * 8 + t6Count * 3);
            const sacrificeValue = hasSacrifice ? (t7Count + t6Count) * 10 : 0;

            return {
                currencyMultiplier: Math.round(currencyMultiplier * 100) / 100,
                rareItemChance: Math.round(rareItemChance),
                uniqueItemChance: Math.round(uniqueItemChance),
                corruptionAvailable: hasCorruption,
                sacrificeValue
            };
        }

        function assessFarming(loot, scaling) {
            const ratings = ['Poor', 'Fair', 'Good', 'Excellent', 'Outstanding'];

            const currencyRating = loot.currencyMultiplier >= 2.5 ? 4 : loot.currencyMultiplier >= 2.0 ? 3 : loot.currencyMultiplier >= 1.5 ? 2 : loot.currencyMultiplier >= 1.2 ? 1 : 0;
            const rareScore = (scaling.rareMonsterChance + scaling.monsterDensity) / 2;
            const rareRating = rareScore >= 80 ? 4 : rareScore >= 60 ? 3 : rareScore >= 40 ? 2 : rareScore >= 20 ? 1 : 0;
            const itemScore = loot.rareItemChance + loot.uniqueItemChance;
            const itemRating = itemScore >= 100 ? 4 : itemScore >= 70 ? 3 : itemScore >= 40 ? 2 : itemScore >= 20 ? 1 : 0;

            const suitability = currencyRating >= 3 && rareRating >= 3 ? 'Excellent all-around farming temple' :
                currencyRating >= 3 ? 'Best for currency farming' :
                rareRating >= 3 ? 'Best for rare monster farming' :
                itemRating >= 3 ? 'Best for item farming' : 'Moderate farming potential';

            return {
                currencyFarming: ratings[currencyRating],
                rareMonsterFarming: ratings[rareRating],
                itemFarming: ratings[itemRating],
                overallSuitability: suitability
            };
        }

        function analyzeRiskReward(scaling, loot, rooms) {
            const riskLevels = ['Low', 'Medium', 'High', 'Very High', 'Extreme'];
            const rewardLevels = ['Low', 'Medium', 'High', 'Very High', 'Exceptional'];

            let riskIndex = scaling.difficulty === 'Easy' ? 0 : scaling.difficulty === 'Moderate' ? 1 : scaling.difficulty === 'Hard' ? 2 : scaling.difficulty === 'Very Hard' ? 3 : 4;
            if (scaling.bossPresent) riskIndex = Math.min(4, riskIndex + 1);

            const rewardScore = loot.currencyMultiplier + loot.rareItemChance / 50 + loot.uniqueItemChance / 25;
            const rewardIndex = rewardScore >= 4.5 ? 4 : rewardScore >= 3.5 ? 3 : rewardScore >= 2.5 ? 2 : rewardScore >= 1.5 ? 1 : 0;

            const roomCount = rooms.filter(r => r.room !== 'empty' && r.room !== 'path').length;
            const timeInvestment = roomCount >= 20 && riskIndex >= 3 ? 'Very Long' : roomCount >= 15 || riskIndex >= 3 ? 'Long' : roomCount >= 10 ? 'Moderate' : 'Quick';

            const recommendation = rewardIndex > riskIndex + 1 ? 'Highly recommended - great rewards for the risk' :
                rewardIndex > riskIndex ? 'Recommended - good risk/reward balance' :
                rewardIndex === riskIndex ? 'Balanced - moderate risk and reward' :
                'Challenging - high risk, consider your build strength';

            return {
                riskLevel: riskLevels[riskIndex],
                rewardPotential: rewardLevels[rewardIndex],
                recommendation,
                timeInvestment
            };
        }

        function evaluateTemple(templeData) {
            const rooms = templeData.rooms || [];
            return {
                chainedBonuses: analyzeChainedRooms(rooms),
                stackedBonuses: analyzeStackedBonuses(rooms),
                monsterScaling: analyzeMonsterScaling(rooms),
                lootModifiers: analyzeLootModifiers(rooms),
                farmingAssessment: assessFarming(analyzeLootModifiers(rooms), analyzeMonsterScaling(rooms)),
                riskReward: analyzeRiskReward(analyzeMonsterScaling(rooms), analyzeLootModifiers(rooms), rooms)
            };
        }

        function analyzeTempleData(templeData) {
            const allRooms = templeData.rooms || [];

            // Room rarity for snake scoring (higher = better for chain)
            const ROOM_RARITY = {
                'viper_spymaster': 10,
                'golem_works': 9,
                'viper_legion_barracks': 8,
                'transcendent_barracks': 7,
                'vault': 6,
                'reward_currency': 5,
                'reward_room': 5,
                'alchemy_lab': 4,
                'flesh_surgeon': 4,
                'synthflesh': 4,
                'thaumaturge': 3,
                'smithy': 3,
                'armoury': 2,
                'generator': 2,
                'garrison': 2,
            };

            // REWARD ROOM type IDs (actual reward rooms that count for snake)
            const REWARD_TYPE_IDS = new Set([
                6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 24
            ]);

            // Handle stacked rooms: keep the BEST room at each position
            // (best = highest tier for same room type, or higher rarity room type)
            const positionMap = {};

            allRooms.forEach(room => {
                if (room.room === 'empty' || room.room === 'path') return;
                if (!REWARD_TYPE_IDS.has(room.roomTypeId)) return;

                const key = `${room.x},${room.y}`;
                const existing = positionMap[key];

                if (!existing) {
                    positionMap[key] = room;
                } else {
                    // Keep the room with higher rarity, or higher tier if same rarity
                    const existingRarity = ROOM_RARITY[existing.room] || 0;
                    const newRarity = ROOM_RARITY[room.room] || 0;

                    if (newRarity > existingRarity || (newRarity === existingRarity && room.tier > existing.tier)) {
                        positionMap[key] = room;
                    }
                }
            });

            const rewardRooms = Object.values(positionMap);

            // Find the best connected snake chain of REWARD rooms
            function findBestChain(rooms) {
                let bestChain = [];
                const visited = new Set();

                rooms.forEach(startRoom => {
                    const key = `${startRoom.x},${startRoom.y}`;
                    if (visited.has(key)) return;

                    const chain = [startRoom];
                    visited.add(key);
                    let current = startRoom;

                    while (true) {
                        let bestNext = null;
                        let bestDist = 999;

                        rooms.forEach(r => {
                            const rKey = `${r.x},${r.y}`;
                            if (chain.some(c => `${c.x},${c.y}` === rKey)) return;
                            const dist = Math.abs(current.x - r.x) + Math.abs(current.y - r.y);
                            if (dist <= 1 && dist < bestDist) {
                                bestDist = dist;
                                bestNext = r;
                            }
                        });

                        if (bestNext) {
                            chain.push(bestNext);
                            visited.add(`${bestNext.x},${bestNext.y}`);
                            current = bestNext;
                        } else break;
                    }

                    if (chain.length > bestChain.length) bestChain = chain;
                });

                return bestChain;
            }

            const bestChain = findBestChain(rewardRooms);
            const chainLength = bestChain.length;

            // Count special rooms
            const spymasters = rewardRooms.filter(r => r.room === 'viper_spymaster').length;
            const golems = rewardRooms.filter(r => r.room === 'golem_works').length;
            const t7Rooms = rewardRooms.filter(r => (r.tier || 0) >= 7).length;
            const t6Rooms = rewardRooms.filter(r => (r.tier || 0) === 6).length;

            // NEW SCORING SYSTEM
            // 1. Snake Chain Score (0-40)
            let snakeScore = 0;
            if (chainLength >= 8) snakeScore = 40;
            else if (chainLength >= 6) snakeScore = 35;
            else if (chainLength >= 5) snakeScore = 30;
            else if (chainLength >= 4) snakeScore = 25;
            else if (chainLength >= 3) snakeScore = 15;
            else if (chainLength >= 2) snakeScore = 6;
            else snakeScore = 2;

            // 2. Room Quality Score (0-50) plus tech synergy bonus
            let roomScore = 0;
            roomScore += spymasters * 10;
            roomScore += golems * 8;
            roomScore += t7Rooms * 20;
            roomScore += Math.min(15, t6Rooms * 3);

            // Bonus for MANY T6+ rooms
            const highTierCount = rewardRooms.filter(r => (r.tier || 0) >= 6).length;
            if (highTierCount >= 5) roomScore += 10;

            // Cap quality score to its intended 50-point scale
            roomScore = Math.min(50, roomScore);

            // Tech synergy bonus: reward Spymaster + Golem tech lines
            let techBonus = 0;
            if (spymasters >= 1 && golems >= 3) {
                techBonus = 20; // Russian Tech + Roman Road combo
            } else if (spymasters >= 1 || golems >= 3) {
                techBonus = 10;
            }

            // Tech penalty: harshly penalize temples with no golems and no T7 rooms
            let techPenalty = 0;
            if (golems === 0 && t7Rooms === 0) {
                techPenalty = 40;
            } else if (golems === 0) {
                techPenalty = 20;
            }

            // 3. Quantity Score (0-15)
            const quantityScore = Math.min(15, rewardRooms.length * 0.8);

            const totalScore = Math.max(0, Math.round(snakeScore + roomScore + techBonus - techPenalty + quantityScore));

            let starRating;
            let ratingDescription;

            if (totalScore >= 85) {
                starRating = 5;
                ratingDescription = 'God Tier - Exceptional temple with outstanding quality';
            } else if (totalScore >= 70) {
                starRating = 4.5;
                ratingDescription = 'Excellent - Very strong layout with high-value rooms';
            } else if (totalScore >= 55) {
                starRating = 4;
                ratingDescription = 'Very Good - Strong snake chain and good rewards';
            } else if (totalScore >= 40) {
                starRating = 3.5;
                ratingDescription = 'Good - Decent snake chain with valuable rooms';
            } else if (totalScore >= 28) {
                starRating = 3;
                ratingDescription = 'Average - Basic optimization with some value';
            } else if (totalScore >= 16) {
                starRating = 2;
                ratingDescription = 'Below Average - Weak snake chain, limited rewards';
            } else {
                starRating = 1;
                ratingDescription = 'Poor - Broken snake chain, no optimization';
            }

            const suggestions = [];
            if (chainLength < 4) {
                suggestions.push('Snake chain is only ' + chainLength + ' rooms. Aim for 4+ connected reward rooms.');
            }
            if (rewardRooms.length < 10) {
                suggestions.push('Consider adding more reward rooms to the temple.');
            }

            return {
                roomCount: allRooms.length,
                rewardRooms: rewardRooms.length,
                architectRooms: allRooms.filter(r => r.room === 'architect').length,
                bossRooms: allRooms.filter(r => r.room === 'boss' || r.room === 'atziri').length,
                avgTier: 0,
                highTierRooms: highTierCount,
                spymasters: spymasters,
                golems: golems,
                t7Rooms: t7Rooms,
                snakeScore: snakeScore,
                roomScore: roomScore,
                quantityScore: quantityScore,
                techBonus,
                techPenalty,
                totalScore,
                starRating,
                ratingDescription,
                suggestions,
                bestChain: bestChain
            };
        }
        
        function renderStars(rating) {
            let html = '';
            const fullStars = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    html += '<span class="star filled">‚òÖ</span>';
                } else if (i === fullStars && hasHalf) {
                    html += '<span class="star filled">‚òÖ</span>';
                } else {
                    html += '<span class="star">‚òÖ</span>';
                }
            }
            
            return html;
        }
        
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'Icon');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                content.classList.add('open');
                icon.classList.add('open');
            }
        }

        // Render all rooms with their details
        function renderRooms(rooms) {
            const roomsSection = document.getElementById('roomsSection');
            const roomsGrid = document.getElementById('roomsGrid');
            const roomStatsSummary = document.getElementById('roomStatsSummary');

            if (!rooms || rooms.length === 0) {
                roomsSection.style.display = 'none';
                return;
            }

            roomsSection.style.display = 'block';
            roomsGrid.innerHTML = '';
            roomStatsSummary.innerHTML = '';

            // Calculate stats
            const stats = {
                total: rooms.length,
                tier7: 0,
                tier6: 0,
                rewardRooms: 0,
                specialRooms: 0,
                bossRooms: 0,
                architectRooms: 0
            };

            rooms.forEach(room => {
                const tier = room.tier || 0;
                if (tier >= 7) stats.tier7++;
                if (tier >= 6) stats.tier6++;

                const roomType = ROOM_TYPES[room.room] || { type: 'unknown' };
                if (roomType.type === 'reward') stats.rewardRooms++;
                if (roomType.type === 'special') stats.specialRooms++;
                if (roomType.type === 'boss') stats.bossRooms++;
                if (roomType.type === 'architect') stats.architectRooms++;
            });

            // Render stats
            roomStatsSummary.innerHTML = `
                <div class="room-stat"><span>Total Rooms:</span> <span class="room-stat-value">${stats.total}</span></div>
                <div class="room-stat"><span>Tier 7:</span> <span class="room-stat-value">${stats.tier7}</span></div>
                <div class="room-stat"><span>Tier 6+:</span> <span class="room-stat-value">${stats.tier6}</span></div>
                <div class="room-stat"><span>Reward Rooms:</span> <span class="room-stat-value">${stats.rewardRooms}</span></div>
                <div class="room-stat"><span>Special:</span> <span class="room-stat-value">${stats.specialRooms}</span></div>
                <div class="room-stat"><span>Boss:</span> <span class="room-stat-value">${stats.bossRooms}</span></div>
                <div class="room-stat"><span>Architects:</span> <span class="room-stat-value">${stats.architectRooms}</span></div>
            `;

            // Render room cards
            rooms.forEach(room => {
                const effectData = ROOM_EFFECTS[room.room] || {
                    icon: '‚ùì',
                    name: room.room.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    nameVi: room.room,
                    effects: ['Unknown effects'],
                    effectsVi: ['Hi·ªáu ·ª©ng kh√¥ng x√°c ƒë·ªãnh'],
                    monsterScaling: 'Unknown',
                    lootMods: 'Unknown'
                };

                const roomType = ROOM_TYPES[room.room] || { type: 'unknown' };
                const tier = room.tier || 0;
                const tierClass = tier >= 7 ? 'tier-7' : tier >= 6 ? 'tier-6' : tier >= 5 ? 'tier-5' : tier >= 4 ? 'tier-4' : tier >= 3 ? 'tier-3' : tier >= 2 ? 'tier-2' : 'tier-1';

                const card = document.createElement('div');
                card.className = `room-card ${tierClass} ${roomType.type}`;
                card.dataset.filter = roomType.type;
                card.dataset.tier = tier;
                card.dataset.roomName = room.room;

                const effectsList = effectData.effects.map((effect, i) =>
                    `<div class="room-effect-item"><span class="effect-bullet">‚óè</span><span>${effect}</span></div>`
                ).join('');

                card.innerHTML = `
                    <span class="room-type-badge ${roomType.type}">${roomType.type}</span>
                    <div class="room-card-header">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span class="room-icon">${effectData.icon}</span>
                            <span class="room-name">${effectData.name}</span>
                        </div>
                        <span class="room-tier ${tierClass}">T${tier}</span>
                    </div>
                    <div class="room-position">Position: (${room.x}, ${room.y})</div>
                    <div class="room-effects">
                        ${effectsList}
                    </div>
                    <div class="room-loot-modifiers">
                        <span class="loot-modifier-tag loot-modifier-tier">T${tier}</span>
                        <span class="loot-modifier-tag">${effectData.monsterScaling}</span>
                        <span class="loot-modifier-tag positive">+${tier * 5}% loot</span>
                    </div>
                `;

                card.addEventListener('click', () => {
                    card.classList.toggle('expanded');
                });

                roomsGrid.appendChild(card);
            });

            // Setup filter buttons
            const filterButtons = document.getElementById('filterButtons');
            filterButtons.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;
                    roomsGrid.querySelectorAll('.room-card').forEach(card => {
                        let show = false;

                        if (filter === 'all') {
                            show = true;
                        } else if (filter === 'tier-7') {
                            show = parseInt(card.dataset.tier) >= 7;
                        } else if (filter === 'tier-6') {
                            show = parseInt(card.dataset.tier) >= 6;
                        } else {
                            show = card.dataset.filter === filter;
                        }

                        card.style.display = show ? 'block' : 'none';
                    });
                });
            });
        }

        function renderEvaluation(evaluation) {
            // Chained Bonuses
            const chainedSection = document.getElementById('chainedBonusesSection');
            const chainedList = document.getElementById('chainedBonusesList');
            if (evaluation.chainedBonuses.length > 0) {
                chainedSection.style.display = 'block';
                chainedList.innerHTML = '';
                evaluation.chainedBonuses.forEach(bonus => {
                    const li = document.createElement('li');
                    li.className = 'chain-item';
                    li.innerHTML = `
                        <div class="chain-header">
                            <span class="chain-type">${bonus.description}</span>
                            <span class="chain-multiplier">${bonus.multiplier.toFixed(2)}x</span>
                        </div>
                        <div class="chain-desc">${bonus.rooms.length} rooms connected with ${Math.round((bonus.multiplier - 1) * 100)}% bonus</div>
                    `;
                    chainedList.appendChild(li);
                });
            } else {
                chainedSection.style.display = 'none';
            }

            // Stacked Bonuses
            const stackedSection = document.getElementById('stackedBonusesSection');
            const stackedList = document.getElementById('stackedBonusesList');
            if (evaluation.stackedBonuses.length > 0) {
                stackedSection.style.display = 'block';
                stackedList.innerHTML = '';
                evaluation.stackedBonuses.forEach(bonus => {
                    const li = document.createElement('li');
                    li.className = 'stacked-item';
                    const roomName = bonus.roomType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    li.innerHTML = `
                        <div class="stacked-header">
                            <span class="stacked-room">${roomName}</span>
                            <span class="stacked-count">x${bonus.count}</span>
                        </div>
                        <div class="stacked-values">
                            <span>Base: <strong>${bonus.baseValue}</strong></span>
                            <span>Actual: <strong>${bonus.actualValue}</strong></span>
                            <span>DR: <strong>${bonus.diminishingReturn}%</strong></span>
                        </div>
                    `;
                    stackedList.appendChild(li);
                });
            } else {
                stackedSection.style.display = 'none';
            }

            // Monster Scaling
            const monsterSection = document.getElementById('monsterScalingSection');
            monsterSection.style.display = 'block';
            const difficultyClass = 'difficulty-' + evaluation.monsterScaling.difficulty.toLowerCase().replace(' ', '-');
            document.getElementById('monsterDifficulty').innerHTML = `<span class="difficulty-badge ${difficultyClass}">${evaluation.monsterScaling.difficulty}</span>`;
            document.getElementById('avgTier').textContent = 'T' + evaluation.monsterScaling.averageTier;
            document.getElementById('monsterDensityValue').textContent = evaluation.monsterScaling.monsterDensity + '%';
            document.getElementById('monsterDensityBar').style.width = evaluation.monsterScaling.monsterDensity + '%';
            document.getElementById('rareChanceValue').textContent = evaluation.monsterScaling.rareMonsterChance + '%';
            document.getElementById('rareChanceBar').style.width = evaluation.monsterScaling.rareMonsterChance + '%';
            document.getElementById('bossPresent').textContent = evaluation.monsterScaling.bossPresent ? '‚úì Yes' : '‚úó No';
            document.getElementById('bossPresent').className = 'metric-value ' + (evaluation.monsterScaling.bossPresent ? 'red' : 'green');

            // Loot Modifiers
            const lootSection = document.getElementById('lootModifiersSection');
            lootSection.style.display = 'block';
            document.getElementById('currencyMultiplier').textContent = evaluation.lootModifiers.currencyMultiplier + 'x';
            document.getElementById('rareItemValue').textContent = evaluation.lootModifiers.rareItemChance + '%';
            document.getElementById('rareItemBar').style.width = evaluation.lootModifiers.rareItemChance + '%';
            document.getElementById('uniqueItemValue').textContent = evaluation.lootModifiers.uniqueItemChance + '%';
            document.getElementById('uniqueItemBar').style.width = evaluation.lootModifiers.uniqueItemChance + '%';
            document.getElementById('corruptionAvailable').textContent = evaluation.lootModifiers.corruptionAvailable ? '‚úì Available' : '‚úó Not Available';
            document.getElementById('corruptionAvailable').className = 'metric-value ' + (evaluation.lootModifiers.corruptionAvailable ? 'purple' : 'red');
            document.getElementById('sacrificeValue').textContent = evaluation.lootModifiers.sacrificeValue;

            // Farming Assessment
            const farmingSection = document.getElementById('farmingSection');
            farmingSection.style.display = 'block';
            const getRatingClass = (rating) => 'rating-' + rating.toLowerCase();
            document.getElementById('currencyFarming').innerHTML = `<span class="rating-badge ${getRatingClass(evaluation.farmingAssessment.currencyFarming)}">${evaluation.farmingAssessment.currencyFarming}</span>`;
            document.getElementById('rareMonsterFarming').innerHTML = `<span class="rating-badge ${getRatingClass(evaluation.farmingAssessment.rareMonsterFarming)}">${evaluation.farmingAssessment.rareMonsterFarming}</span>`;
            document.getElementById('itemFarming').innerHTML = `<span class="rating-badge ${getRatingClass(evaluation.farmingAssessment.itemFarming)}">${evaluation.farmingAssessment.itemFarming}</span>`;
            document.getElementById('farmingRecommendation').textContent = evaluation.farmingAssessment.overallSuitability;

            // Risk vs Reward
            const riskSection = document.getElementById('riskRewardSection');
            riskSection.style.display = 'block';
            document.getElementById('riskLevel').textContent = evaluation.riskReward.riskLevel;
            document.getElementById('riskLevel').className = 'risk-reward-value red';
            document.getElementById('rewardPotential').textContent = evaluation.riskReward.rewardPotential;
            document.getElementById('rewardPotential').className = 'risk-reward-value green';
            document.getElementById('timeInvestment').textContent = evaluation.riskReward.timeInvestment;
            document.getElementById('timeInvestment').className = 'risk-reward-value cyan';
            document.getElementById('riskRecommendation').textContent = evaluation.riskReward.recommendation;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('visible');
        }
        
        async function analyzeTemple() {
            hideError();

            const shareUrl = document.getElementById('shareUrl').value.trim();

            if (!shareUrl) {
                showError('Please paste a share URL');
                return;
            }

            // Security: Validate URL before processing
            if (!validateShareURL(shareUrl)) {
                showError('Invalid temple share URL. Please check the URL format.');
                return;
            }

            // Cache loading elements
            const loadingEl = document.getElementById('loading');
            const resultSection = document.getElementById('resultSection');

            loadingEl.classList.add('visible');
            resultSection.classList.remove('visible');
            
            // Small delay for UX
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                const encodedData = extractShareData(shareUrl);
                
                if (!encodedData) {
                    throw new Error('Could not extract temple data from URL. Make sure the URL contains "?t=" parameter.');
                }
                
                const templeData = decodeTempleData(encodedData);
                
                if (!templeData) {
                    throw new Error('Failed to decode temple data. The data may be corrupted or use a different encoding format.');
                }
                
                const analysis = analyzeTempleData(templeData);
                const evaluation = evaluateTemple(templeData);

                // Cache DOM elements to minimize queries
                const elements = {
                    stars: document.getElementById('stars'),
                    ratingTitle: document.getElementById('ratingTitle'),
                    ratingDescription: document.getElementById('ratingDescription'),
                    totalScore: document.getElementById('totalScore'),
                    rewardScore: document.getElementById('rewardScore'),
                    techScore: document.getElementById('techScore'),
                    roomCount: document.getElementById('roomCount'),
                    rewardRooms: document.getElementById('rewardRooms'),
                    architectRooms: document.getElementById('architectRooms'),
                    rewardDensity: document.getElementById('rewardDensity'),
                    suggestionsSection: document.getElementById('suggestionsSection'),
                    suggestionsList: document.getElementById('suggestionsList'),
                    rewardProgress: document.getElementById('rewardProgress'),
                    techProgress: document.getElementById('techProgress'),
                    techBadges: document.getElementById('techBadges'),
                    loading: document.getElementById('loading'),
                    resultSection: document.getElementById('resultSection')
                };

                // Batch DOM updates using requestAnimationFrame to reduce reflows
                requestAnimationFrame(() => {
                    // Update rating section
                    elements.stars.innerHTML = renderStars(analysis.starRating);
                    elements.ratingTitle.textContent = analysis.starRating + ' Stars';
                    elements.ratingDescription.textContent = analysis.ratingDescription;

                    // Update score section
                    elements.totalScore.textContent = analysis.totalScore;
                    elements.rewardScore.textContent = analysis.snakeScore;
                    elements.techScore.textContent = analysis.roomScore;

                    // Update stat cards
                    elements.roomCount.textContent = analysis.roomCount;
                    elements.rewardRooms.textContent = analysis.rewardRooms;
                    elements.architectRooms.textContent = analysis.architectRooms;
                    elements.rewardDensity.textContent = Math.round(analysis.quantityScore) + '%';

                    // Update suggestions using DocumentFragment for batch insertion
                    if (analysis.suggestions.length > 0) {
                        elements.suggestionsSection.style.display = 'block';
                        elements.suggestionsList.textContent = '';

                        // Use DocumentFragment to minimize reflows
                        const fragment = document.createDocumentFragment();
                        analysis.suggestions.forEach(s => {
                            const li = document.createElement('li');
                            li.textContent = s;
                            fragment.appendChild(li);
                        });
                        elements.suggestionsList.appendChild(fragment);
                    } else {
                        elements.suggestionsSection.style.display = 'none';
                    }

                    // Update progress bars
                    elements.rewardProgress.style.width = (analysis.snakeScore / 40 * 100) + '%';
                    elements.techProgress.style.width = (analysis.roomScore / 50 * 100) + '%';

                    // Update tech badges
                    elements.techBadges.textContent = '';
                    const techBonuses = analysis.techBonuses || [];
                    techBonuses.forEach((bonus) => {
                        const badge = document.createElement('div');
                        badge.className = 'tech-badge' + (bonus.detected ? ' active' : '');
                        badge.textContent = bonus.name + (bonus.detected ? ` (+${bonus.score})` : '');
                        if (bonus.detected && bonus.description) {
                            badge.title = bonus.description;
                        }
                        elements.techBadges.appendChild(badge);
                    });

                    // Render evaluation sections
                    renderEvaluation(evaluation);

                    // Render all rooms with details
                    renderRooms(templeData.rooms);
                });

                // Show/hide sections (outside requestAnimationFrame for immediate feedback)
                elements.loading.classList.remove('visible');
                elements.resultSection.classList.add('visible');
                
            } catch (error) {
                // Use cached loading element
                const loadingEl = document.getElementById('loading');
                loadingEl.classList.remove('visible');
                showError(error.message);
            }
        }
        
            // Allow Enter key to trigger analysis
            document.getElementById('shareUrl').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    analyzeTemple();
                }
            });

            // Expose necessary functions to global scope for event handlers
            window.analyzeTemple = analyzeTemple;
            window.toggleSection = toggleSection;

        })();
    </script>
</body>
</html>

